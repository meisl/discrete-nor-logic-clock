<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE script:module PUBLIC "-//OpenOffice.org//DTD OfficeDocument 1.0//EN" "module.dtd">
<script:module xmlns:script="http://openoffice.org/2000/script" script:name="M00_Test" script:language="StarBasic">REM  *****  BASIC  *****
Option Explicit

Type TTestPass
	n As Integer
	isFail As Boolean	
	x As String
End Type

Type TTestFail
	n As Integer
	isFail As Boolean	
	actual As Variant
	expected As Variant
	msg As String
End Type

Type TTest_Dummy
End Type

Public testLevel As Integer
Public assertionCount As Integer

Sub Main
	test_Test()
End Sub

Function _argsStr(fName As String, args As Array)
On Local Error Goto JustSomething
	If fName = &quot;toString&quot; Then	&apos; we cannot use toString if we were just called from there
		Goto JustSomething
	End If
	_argsStr = toString(args)
	Exit Function
JustSomething:
	_argsStr = &quot;(???)&quot;
End Function

Function mkFail(actual As Variant, expected As Variant, msg As String)
	Dim result As Object
	Set result = new TTestFail
	result.isFail = True
	result.actual = actual
	result.expected = expected
	result.msg = msg
	If (testLevel = 0) Then
		MsgBox(&quot;FAIL: &quot; &amp; msg)
	End If
	mkFail = result
End Function

Function mkPass()
	Dim result As Object
	Set result = New TTestPass
	result.isFail = False
	mkPass = result
End Function

Function assertThrows(vF As Variant, args As Array, Optional errNo As Integer)
	assertionCount = assertionCount + 1
	Dim result As Object, a As String, x As String
	Dim fResult As Variant
	Dim k As Integer, n As Integer
	If Not(isArray(args)) Then
		croak(&quot;assertThrows: expected Array of args but got&quot; &amp; chr(13) &amp; toString(args))
	End If
	k = LBound(args)
	n = UBound(args) - k + 1
	Dim fName As String, f As Object
	If isString(vF) Then
		fName = vF
		Select Case fName
			Case &quot;assertEqual&quot;:	
			Case &quot;assertThrows&quot;
			Case &quot;i_will_throw0&quot;
			Case Else
				f = lookupFn(fName)
				If isEmpty(f) Then
					croak(&quot;assertThrows: unknown fn &quot; &amp; toString(fName))
				End If
		End Select
	ElseIf isFn(vF) Then
		fName = getFnName(vF)
		f = vF
	Else
		croak(&quot;assertThrows: invalid 1st arg - expected fn, got &quot; &amp; toString(vF))
	End If	

	Select Case fName
		Case &quot;assertEqual&quot;:
			testLevel = testLevel + 1
On Local Error Goto Boom
		 	fResult = assertEqual(args(k), args(k+1))
		Case &quot;assertThrows&quot;
			If n = 2 Then
				testLevel = testLevel + 1
On Local Error Goto Boom
				fResult = assertThrows(args(k), args(k+1))
			ElseIf n = 3 Then
				testLevel = testLevel + 1
On Local Error Goto Boom
				fResult = assertThrows(args(k), args(k+1), args(k+2))
			Else
				croak(&quot;assertThrows: expected Array of 2 or 3 args but got&quot; &amp; chr(13) &amp; toString(args))
			End If
		Case &quot;i_will_throw0&quot;:
			testLevel = testLevel + 1
On Local Error Goto Boom
			fResult = i_will_throw0()
		Case Else
			Dim argsList As Object
			argsList = toList(args)
			If isNil(argsList) Then
				croak(&quot;assertThrows: don&apos;t know how to apply zero args - fn:&quot; &amp; chr(13) &amp; toString(fName))
			Else 
				testLevel = testLevel + 1
On Local Error Goto Boom
				fResult = applyToList(f, argsList)
			End If
	End Select
	testLevel = testLevel - 1
	a = &quot;no error&quot;
	x = IIf(IsMissing(errNo), &quot;an error&quot;, &quot;error &quot; &amp; errNo)
	Dim msg As String
	msg = &quot;expected fn &apos;&quot; &amp; fName &amp; &quot;&apos; to yield &quot; &amp; x
On Local Error Goto skipMsgPart1	
	 msg = msg &amp; &quot; on args&quot; &amp; chr(13) &amp; _argsStr(fName, args)
skipMsgPart1:
On Local Error Goto skipMsgPart2	
	 msg = msg &amp; chr(13) &amp; &quot;returned &quot; &amp; toString(fResult)
skipMsgPart2:
	Set result = mkFail(a, x, msg)
	assertThrows = result
	Exit Function
Boom:
	testLevel = testLevel - 1
	If Not(IsMissing(errNo)) And (errNo &lt;&gt; Err) Then
		a = &quot;error &quot; &amp; Err &amp; &quot;: &quot; &amp; toString(Error$)
		x = &quot;error &quot; &amp; errNo &amp; &quot;: &quot; &amp; toString(Error(errNo))
		Set result = mkFail(a, x, _
			&quot;expected fn &apos;&quot; &amp; fName &amp; &quot;&apos; to yield&quot; _
				&amp; chr(13) &amp; &quot;       &quot; &amp; x _
				&amp; chr(13) &amp; &quot; not &quot; &amp; a _
				&amp; chr(13) &amp; &quot;on args:&quot; _
				&amp; chr(13) &amp; _argsStr(fName, args) _
		)
	Else
		Set result = mkPass()
		result.x = Err &amp; &quot;: &quot; &amp; Error$
	End If
	assertThrows = result
End Function

Function assertEqual(actual As Variant, expected As Variant)
	assertionCount = assertionCount + 1
	Dim result As Object
	Dim ta As String, tx As String
	ta = typeOf(actual)
	tx = typeOf(expected)
	If (ta &lt;&gt; tx) Then
		If ((ta = &quot;Long&quot;) And (tx = &quot;Integer&quot;))_
		Or ((ta = &quot;Integer&quot;) And (tx = &quot;Long&quot;))Then
			If (actual = expected) Then
				Goto assertEqual_passed
			End If
		Else
			Goto assertEqual_failed
		End If
	ElseIf (isObject(actual) And isObject(expected)) Then
		If (isNull(actual) = isNull(expected)) Then &apos; either both null or both not
			If (isNull(actual) And isNull(expected)) Then
				Goto assertEqual_passed
			Else
				croak(&quot;assertEqual: cannot compare non-null Objects - test custom equ fn instead&quot;)
			End If
		Else &apos; one null, the other not
			Goto assertEqual_failed
		End If
	ElseIf (actual = expected) Then
		Goto assertEqual_passed
	End If
assertEqual_failed:
	assertEqual = mkFail(actual, expected, _
			&quot;expected &quot; &amp; toString(actual) _
				&amp; chr(13) &amp; &quot;     to equal &quot; &amp; toString(expected) _
		)
	Exit Function
assertEqual_passed:
	assertEqual = mkPass()
	Exit Function
End Function

Function assertPasses(assertionName As String, args As Array)
	assertionCount = assertionCount + 1
	Dim result As Object, innerResult As Object
	Select Case assertionName
		Case &quot;assertEqual&quot;
			testLevel = testLevel + 1
			innerResult = assertEqual(args(0), args(1))
			testLevel = testLevel - 1
			If innerResult.isFail Then
				Dim a As Object, x As String
				a = innerResult
				x = &quot;pass&quot;
				Set result = mkFail(a, x, _
					&quot;expected &quot; &amp; assertionName &amp; &quot; to pass on args &quot; _
						&amp; chr(13) &amp; &quot;  &quot; &amp; _argsStr(assertionName, args) _
						&amp; chr(13) &amp; &quot;but it failed:&quot; _
						&amp; chr(13) &amp; a.msg _
				)
			Else
				Set result = mkPass()
			End If
		Case Else
			croak(&quot;assertPasses: unknown assertion &apos;&quot; &amp; assertionName &amp; &quot;&apos;&quot;)
	End Select
	assertPasses = result
End Function

Function assertFails(assertionName As String, args As Array)
	assertionCount = assertionCount + 1
	Dim result As Object, innerResult As Object
	Select Case assertionName
		Case &quot;assertEqual&quot;
			testLevel = testLevel + 1
			innerResult = assertEqual(args(0), args(1))
			testLevel = testLevel - 1
			If Not(innerResult.isFail) Then
				Dim a As Object, x As String
				a = innerResult
				x = &quot;fail&quot;
				Set result = mkFail(a, x, _
					&quot;expected &quot; &amp; assertionName &amp; &quot; to fail on args &quot; _
						&amp; chr(13) &amp; &quot;  &quot; &amp; _argsStr(assertionName, args) _
						&amp; chr(13) &amp; &quot;but it passed.&quot; _
				)
			Else
				Set result = mkPass()
			End If
		Case Else
			croak(&quot;assertFails: unknown assertion &apos;&quot; &amp; assertionName &amp; &quot;&apos;&quot;)
	End Select
	assertFails = result
End Function

Function testStat(which As String, statsStr As String)
	Dim stats As Variant
	stats = Split(statsStr, &quot; &quot;)
	Select Case which
		Case &quot;name&quot;:	testStat = stats(0)
		Case &quot;time&quot;:	testStat = CDbl(stats(1))
		Case &quot;count&quot;:	testStat = CLng(stats(2))
		Case Else
			croak(&quot;no such stat: &quot; &amp; which)
	End Select
End Function

&apos; ==================================================================

Function i_will_throw0()
	Dim foo As Object
	i_will_throw0 = foo.provoke.an.error
End Function

Function test_Test()
	test_assertEqual()
	test_assertThrows()
	test_testStat()
End Function

Function test_assertEqual()
	Dim aName As String
	aName = &quot;assertEqual&quot;
	
	assertEqual(False, False).x
	assertPasses(aName, Array(False, False)).x

	assertEqual(True, True).x
	assertPasses(aName, Array(True, True)).x

	assertEqual(0, 0).x
	assertPasses(aName, Array(0, 0)).x

	Dim aLong As Long, aInt As Integer
	aLong = 9
	aInt = 9
	assertPasses(aName, Array(aLong, aInt)).x
	assertPasses(aName, Array(aInt, aLong)).x
	assertFails(aName, Array(&quot;9&quot;, aInt)).x
	assertFails(aName, Array(&quot;9&quot;, aLong)).x
	assertFails(aName, Array(aInt,  &quot;9&quot;)).x
	assertFails(aName, Array(aLong, &quot;9&quot;)).x

	aInt = 7
	assertFails(aName, Array(aLong, aInt)).x
	assertFails(aName, Array(aInt, aLong)).x

	assertEqual(&quot;0&quot;, &quot;0&quot;).x
	assertPasses(aName, Array(&quot;0&quot;, &quot;0&quot;)).x

	assertEqual(&quot;a&quot;, &quot;a&quot;).x
	assertPasses(aName, Array(&quot;a&quot;, &quot;a&quot;)).x

	assertEqual(Nothing, Nothing).x
	assertPasses(aName, Array(Nothing, Nothing)).x

	assertEqual(Empty, Empty).x
	assertPasses(aName, Array(Empty, Empty)).x

	assertFails(aName, Array(False, True)).x
	assertFails(aName, Array(True, False)).x
	
	assertFails(aName, Array(False, Empty)).x
	assertFails(aName, Array(Empty, False)).x

	assertFails(aName, Array(True, Empty)).x
	assertFails(aName, Array(Empty, True)).x

	assertFails(aName, Array(False, Nothing)).x
	assertFails(aName, Array(Nothing, False)).x

	assertFails(aName, Array(True, Nothing)).x
	assertFails(aName, Array(Nothing, True)).x

	assertFails(aName, Array(False, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, False)).x

	assertFails(aName, Array(True, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, True)).x

	assertFails(aName, Array(False, 0)).x
	assertFails(aName, Array(0, False)).x

	assertFails(aName, Array(True, 0)).x
	assertFails(aName, Array(0, True)).x

	assertFails(aName, Array(False, 1)).x
	assertFails(aName, Array(1, False)).x

	assertFails(aName, Array(True, 1)).x
	assertFails(aName, Array(1, True)).x

	assertFails(aName, Array(False, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, False)).x

	assertFails(aName, Array(True, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, True)).x

	assertFails(aName, Array(False, &quot;a&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, False)).x

	assertFails(aName, Array(True, &quot;a&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, True)).x


	assertFails(aName, Array(Empty, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, Empty)).x

	assertFails(aName, Array(Nothing, &quot;&quot;)).x
	assertFails(aName, Array(&quot;&quot;, Nothing)).x
	
	assertFails(aName, Array(Empty, &quot;a&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, Empty)).x

	assertFails(aName, Array(Nothing, &quot;a&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, Nothing)).x

	Dim dummy As Object
	assertFails(aName, Array(Empty, dummy)).x
	assertFails(aName, Array(dummy, Empty)).x

	assertPasses(aName, Array(Nothing, dummy)).x
	assertPasses(aName, Array(dummy, Nothing)).x

	Set dummy = New TTest_Dummy
	assertFails(aName, Array(Empty, dummy)).x
	assertFails(aName, Array(dummy, Empty)).x

	assertFails(aName, Array(Nothing, dummy)).x
	assertFails(aName, Array(dummy, Nothing)).x

	assertThrows(aName, Array(dummy, dummy)).x


	assertFails(aName, Array(0, 1)).x
	assertFails(aName, Array(0, &quot;1&quot;)).x
	assertFails(aName, Array(0, False)).x
	assertFails(aName, Array(0, True)).x
	
	assertFails(aName, Array(&quot;0&quot;, &quot;1&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, &quot;b&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, &quot;b&quot;)).x
	
	assertFails(aName, Array(Nothing, Empty)).x
	assertFails(aName, Array(Empty, Nothing)).x
	
	assertFails(aName, Array(Empty, 0)).x
	assertFails(aName, Array(0, Empty)).x
	
	assertFails(aName, Array(Empty, &quot;a&quot;)).x
	assertFails(aName, Array(&quot;a&quot;, Empty)).x

	assertFails(aName, Array(Nothing, 0)).x
	assertFails(aName, Array(0, Nothing)).x

	assertFails(aName, Array(&quot;a&quot;, Nothing)).x
	
End Function

Function test_assertThrows()
	assertThrows(&quot;i_will_throw0&quot;, Array()).x
	assertThrows(&quot;i_will_throw0&quot;, Array(), 91).x
	assertThrows(&quot;i_will_throw0&quot;, Array(5)).x
	
	&apos; inner assertThrows throws because *IT* gets no args (so the outer passes)
&apos;	assertThrows(&quot;assertThrows&quot;, Array()).x
	
	&apos; inner assertThrows throws because *IT* gets no valid arg array to pass on (so the outer passes)
	&apos; (inner assertThrows expects Array as 2nd arg)
	assertThrows(&quot;assertThrows&quot;, Array(&quot;assertEqual&quot;, 2, 2)).x

&apos;	assertFails(&quot;assertThrows&quot;, Array(&quot;assertEqual&quot;, Array(2, 2))).x
&apos;	assertFails(&quot;assertThrows&quot;, Array(&quot;assertEqual&quot;, Array(2, 3))).x

&apos;	assertPasses(&quot;assertThrows&quot;, Array(&quot;i_will_throw0&quot;, Nothing)).x
End Function

Function test_testStat()
	assertEqual(testStat(&quot;name&quot;,  &quot;foobar 5,5 987&quot;), &quot;foobar&quot;).x
	assertEqual(testStat(&quot;time&quot;,  &quot;foobar 5,5 987&quot;), 5.5).x
	assertEqual(testStat(&quot;count&quot;, &quot;foobar 5,5 987&quot;), 987).x
End Function

</script:module>